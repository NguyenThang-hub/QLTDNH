import customtkinter as ctk
from tkinter import messagebox, Menu
from DAO.DatabaseOperation import *
from Bill import BillManager
from Table import choose_table_window
from Admin import AdminMode

class MenuForGuest:
    def __init__(self, root, username):
        self.root = root
        self.username = username
        self.root.title("Th·ª±c ƒë∆°n nh√† h√†ng")
        self.root.geometry("900x700")
        ctk.set_appearance_mode("light")
        ctk.set_default_color_theme("green")

        # L·∫•y d·ªØ li·ªáu m√≥n ƒÉn t·ª´ database (s·∫Ω ƒë∆∞·ª£c l√†m m·ªõi khi c·∫ßn)
        self.load_menu_items()

        self.selected_table = None
        self.table_orders = {}

        self.main_quantities = {}
        self.side_quantities = {}
        self.accomp_quantities = {}
        self.drink_quantities = {}

        # Main frame
        main_frame = ctk.CTkFrame(root)
        main_frame.pack(fill="both", expand=True)

        # Sidebar
        sidebar = ctk.CTkFrame(main_frame, width=200, corner_radius=10)
        sidebar.pack(side="left", fill="y", padx=10, pady=10)

        ctk.CTkLabel(sidebar, text="Danh m·ª•c", font=ctk.CTkFont(size=16, weight="bold")).pack(pady=(10, 20))
        ctk.CTkButton(sidebar, text="ü™ë Ch·ªçn b√†n", command=self.open_table_window).pack(pady=10)

        ctk.CTkButton(sidebar, text="üçΩÔ∏è M√≥n ch√≠nh", command=lambda: self.show_category("main_dish")).pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(sidebar, text="ü•ó M√≥n ph·ª•", command=lambda: self.show_category("side_dish")).pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(sidebar, text="üçü M√≥n ƒÉn k√®m", command=lambda: self.show_category("accompaniment")).pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(sidebar, text="ü•§ ƒê·ªì u·ªëng", command=lambda: self.show_category("drink")).pack(pady=5, fill="x", padx=10)
        ctk.CTkButton(sidebar, text="üìã Xem t·∫•t c·∫£", command=self.show_all_categories).pack(pady=5, fill="x", padx=10)

        # Content frame
        content_frame = ctk.CTkFrame(main_frame)
        content_frame.pack(side="right", fill="both", expand=True, padx=10, pady=10)

        canvas = ctk.CTkCanvas(content_frame)
        canvas.pack(side="left", fill="both", expand=True)
        scrollbar = ctk.CTkScrollbar(content_frame, command=canvas.yview)
        scrollbar.pack(side="right", fill="y")
        self.scrollable_frame = ctk.CTkFrame(canvas)

        self.scrollable_frame.bind("<Configure>", lambda e: canvas.configure(scrollregion=canvas.bbox("all")))
        canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw", width=content_frame.winfo_width())
        canvas.configure(yscrollcommand=scrollbar.set)

        # C·∫≠p nh·∫≠t chi·ªÅu r·ªông khi content_frame thay ƒë·ªïi k√≠ch th∆∞·ªõc
        content_frame.bind("<Configure>", lambda e: canvas.itemconfig(canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw"), width=e.width))

        # M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã danh m·ª•c ƒë·∫ßu ti√™n (M√≥n ch√≠nh)
        self.show_category("main_dish")

    def load_menu_items(self):
        """T·∫£i l·∫°i d·ªØ li·ªáu m√≥n ƒÉn t·ª´ database"""
        self.main_dishes = get_items_by_category("main_dish")
        self.side_dishes = get_items_by_category("side_dish")
        self.accompaniments = get_items_by_category("accompaniment")
        self.drinks = get_items_by_category("drink")

    def show_category(self, category):
        for widget in self.scrollable_frame.winfo_children():
            widget.destroy()

        ctk.CTkLabel(self.scrollable_frame, text="Th·ª±c ƒë∆°n", font=ctk.CTkFont(size=20, weight="bold")).pack(pady=10, fill="x", padx=10)

        # X√≥a c√°c t·ª´ ƒëi·ªÉn s·ªë l∆∞·ª£ng tr∆∞·ªõc khi hi·ªÉn th·ªã danh m·ª•c m·ªõi
        self.main_quantities = {}
        self.side_quantities = {}
        self.accomp_quantities = {}
        self.drink_quantities = {}

        # Ch·ªçn danh m·ª•c ƒë·ªÉ hi·ªÉn th·ªã
        if category == "main_dish":
            items = self.main_dishes
            title = "üçΩÔ∏è M√≥n ch√≠nh"
            quantities_dict = self.main_quantities
        elif category == "side_dish":
            items = self.side_dishes
            title = "ü•ó M√≥n ph·ª•"
            quantities_dict = self.side_quantities
        elif category == "accompaniment":
            items = self.accompaniments
            title = "üçü M√≥n ƒÉn k√®m"
            quantities_dict = self.accomp_quantities
        else:  # category == "drink"
            items = self.drinks
            title = "ü•§ ƒê·ªì u·ªëng"
            quantities_dict = self.drink_quantities

        ctk.CTkLabel(self.scrollable_frame, text=title, font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=(10, 5), fill="x")
        for item in items:
            frame = ctk.CTkFrame(self.scrollable_frame, corner_radius=10)
            frame.pack(padx=10, pady=5, fill="x")
            ctk.CTkLabel(frame, text=f"{item['name']} ({item['price']:,} VNƒê)", font=ctk.CTkFont(size=13), wraplength=400).pack(side="left", padx=10, pady=5, fill="x", expand=True)
            spin = ctk.CTkComboBox(frame, values=[str(i) for i in range(11)], width=60)
            spin.set("0")
            spin.pack(side="right", padx=10)
            quantities_dict[item['name']] = spin

        btn_frame = ctk.CTkFrame(self.scrollable_frame, fg_color="transparent")
        btn_frame.pack(pady=20, fill="x", padx=10)
        ctk.CTkButton(btn_frame, text="‚úÖ X√°c nh·∫≠n ƒë∆°n", command=self.confirm_order, width=200).pack(pady=5)

        # N·∫øu ƒë√£ ch·ªçn b√†n v√† c√≥ d·ªØ li·ªáu => load l·∫°i
        if self.selected_table in self.table_orders:
            data = self.table_orders[self.selected_table]
            for name, spin in quantities_dict.items():
                spin.set(str(data.get(name, 0)))

    def show_all_categories(self):
        for widget in self.scrollable_frame.winfo_children():
            widget.destroy()

        ctk.CTkLabel(self.scrollable_frame, text="Th·ª±c ƒë∆°n", font=ctk.CTkFont(size=20, weight="bold")).pack(pady=10, fill="x", padx=10)

        # X√≥a c√°c t·ª´ ƒëi·ªÉn s·ªë l∆∞·ª£ng tr∆∞·ªõc khi hi·ªÉn th·ªã t·∫•t c·∫£ danh m·ª•c
        self.main_quantities = {}
        self.side_quantities = {}
        self.accomp_quantities = {}
        self.drink_quantities = {}

        # M√≥n ch√≠nh
        ctk.CTkLabel(self.scrollable_frame, text="üçΩÔ∏è M√≥n ch√≠nh", font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=(10, 5), fill="x")
        for item in self.main_dishes:
            frame = ctk.CTkFrame(self.scrollable_frame, corner_radius=10)
            frame.pack(padx=10, pady=5, fill="x")
            ctk.CTkLabel(frame, text=f"{item['name']} ({item['price']:,} VNƒê)", font=ctk.CTkFont(size=13), wraplength=400).pack(side="left", padx=10, pady=5, fill="x", expand=True)
            spin = ctk.CTkComboBox(frame, values=[str(i) for i in range(11)], width=60)
            spin.set("0")
            spin.pack(side="right", padx=10)
            self.main_quantities[item['name']] = spin

        # M√≥n ph·ª•
        ctk.CTkLabel(self.scrollable_frame, text="ü•ó M√≥n ph·ª•", font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=(15, 5), fill="x")
        for item in self.side_dishes:
            frame = ctk.CTkFrame(self.scrollable_frame, corner_radius=10)
            frame.pack(padx=10, pady=5, fill="x")
            ctk.CTkLabel(frame, text=f"{item['name']} ({item['price']:,} VNƒê)", font=ctk.CTkFont(size=13), wraplength=400).pack(side="left", padx=10, pady=5, fill="x", expand=True)
            spin = ctk.CTkComboBox(frame, values=[str(i) for i in range(11)], width=60)
            spin.set("0")
            spin.pack(side="right", padx=10)
            self.side_quantities[item['name']] = spin

        # M√≥n ƒÉn k√®m
        ctk.CTkLabel(self.scrollable_frame, text="üçü M√≥n ƒÉn k√®m", font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=(15, 5), fill="x")
        for item in self.accompaniments:
            frame = ctk.CTkFrame(self.scrollable_frame, corner_radius=10)
            frame.pack(padx=10, pady=5, fill="x")
            ctk.CTkLabel(frame, text=f"{item['name']} ({item['price']:,} VNƒê)", font=ctk.CTkFont(size=13), wraplength=400).pack(side="left", padx=10, pady=5, fill="x", expand=True)
            spin = ctk.CTkComboBox(frame, values=[str(i) for i in range(11)], width=60)
            spin.set("0")
            spin.pack(side="right", padx=10)
            self.accomp_quantities[item['name']] = spin

        # ƒê·ªì u·ªëng
        ctk.CTkLabel(self.scrollable_frame, text="ü•§ ƒê·ªì u·ªëng", font=ctk.CTkFont(size=16, weight="bold")).pack(anchor="w", padx=10, pady=(15, 5), fill="x")
        for item in self.drinks:
            frame = ctk.CTkFrame(self.scrollable_frame, corner_radius=10)
            frame.pack(padx=10, pady=5, fill="x")
            ctk.CTkLabel(frame, text=f"{item['name']} ({item['price']:,} VNƒê)", font=ctk.CTkFont(size=13), wraplength=400).pack(side="left", padx=10, pady=5, fill="x", expand=True)
            spin = ctk.CTkComboBox(frame, values=[str(i) for i in range(11)], width=60)
            spin.set("0")
            spin.pack(side="right", padx=10)
            self.drink_quantities[item['name']] = spin

        btn_frame = ctk.CTkFrame(self.scrollable_frame, fg_color="transparent")
        btn_frame.pack(pady=20, fill="x", padx=10)
        ctk.CTkButton(btn_frame, text="‚úÖ X√°c nh·∫≠n ƒë∆°n", command=self.confirm_order, width=200).pack(pady=5)

        # N·∫øu ƒë√£ ch·ªçn b√†n v√† c√≥ d·ªØ li·ªáu => load l·∫°i
        if self.selected_table in self.table_orders:
            data = self.table_orders[self.selected_table]
            for name, spin in self.main_quantities.items():
                spin.set(str(data.get(name, 0)))
            for name, spin in self.side_quantities.items():
                spin.set(str(data.get(name, 0)))
            for name, spin in self.accomp_quantities.items():
                spin.set(str(data.get(name, 0)))
            for name, spin in self.drink_quantities.items():
                spin.set(str(data.get(name, 0)))

    def confirm_order(self):
        if not self.selected_table:
            messagebox.showwarning("Th√¥ng b√°o", "Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc khi g·ªçi m√≥n.")
            return

        table_data = {}
        has_order = False

        for item in self.main_dishes:
            quantity = int(self.main_quantities.get(item['name'], ctk.CTkComboBox(values=["0"])).get())
            if quantity > 0:
                table_data[item['name']] = quantity
                has_order = True

        for item in self.side_dishes:
            quantity = int(self.side_quantities.get(item['name'], ctk.CTkComboBox(values=["0"])).get())
            if quantity > 0:
                table_data[item['name']] = quantity
                has_order = True

        for item in self.accompaniments:
            quantity = int(self.accomp_quantities.get(item['name'], ctk.CTkComboBox(values=["0"])).get())
            if quantity > 0:
                table_data[item['name']] = quantity
                has_order = True

        for item in self.drinks:
            quantity = int(self.drink_quantities.get(item['name'], ctk.CTkComboBox(values=["0"])).get())
            if quantity > 0:
                table_data[item['name']] = quantity
                has_order = True

        if not has_order:
            messagebox.showwarning("Th√¥ng b√°o", "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n.")
            return

        self.table_orders[self.selected_table] = table_data
        messagebox.showinfo("X√°c nh·∫≠n ƒë∆°n", f"ƒê∆°n h√†ng cho b√†n {self.selected_table} ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m.")

        table_data = self.table_orders[self.selected_table]
        order_items = []
        total_price = 0
        summary = f"B√†n s·ªë: {self.selected_table}\nM√≥n ƒÉn:\n"

        for item in self.main_dishes + self.side_dishes + self.accompaniments + self.drinks:
            name = item['name']
            if name in table_data and table_data[name] > 0:
                quantity = table_data[name]
                price = quantity * item['price']
                summary += f"{name}: {quantity} x {item['price']:,} = {price:,} VNƒê\n"
                total_price += price
                order_items.append({"name": name, "quantity": quantity, "price": item['price']})

        summary += f"\nT·ªïng c·ªông: {total_price:,} VNƒê"

        order_id = save_order(self.username, total_price, order_items, table_id=self.selected_table)
        if order_id:
            bill_window = BillManager(self.root)
            bill_window.show_invoice(summary, total_price, order_id, self.username)
            del self.table_orders[self.selected_table]
            self.show_category("main_dish")  # Quay l·∫°i danh m·ª•c m·∫∑c ƒë·ªãnh
        else:
            messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ l∆∞u ƒë∆°n h√†ng.")

    def load_menu_items(self):
        """T·∫£i l·∫°i d·ªØ li·ªáu m√≥n ƒÉn t·ª´ database"""
        self.main_dishes = get_items_by_category("main_dish")
        self.side_dishes = get_items_by_category("side_dish")
        self.accompaniments = get_items_by_category("accompaniment")
        self.drinks = get_items_by_category("drink")

    def open_table_window(self):
        choose_table_window(self.root, self.set_selected_table)

    def set_selected_table(self, table_number):
        self.selected_table = table_number
        self.show_category("main_dish")  # C·∫≠p nh·∫≠t danh m·ª•c m·∫∑c ƒë·ªãnh

    def admin_mode(self):
        window = ctk.CTkToplevel(self.root)
        window.title("Ch·∫ø ƒë·ªô qu·∫£n l√Ω!")
        window.geometry("400x300")

        title = ctk.CTkLabel(window, text="X√°c nh·∫≠n ƒëƒÉng nh·∫≠p", font=ctk.CTkFont(size=24, weight="bold"))
        title.pack(pady=(60, 30))

        mk = ctk.CTkEntry(window, placeholder_text="M·∫≠t kh·∫©u", width=250, show="*")
        mk.pack(padx=15, pady=10)
        mk.focus()

        error_label = ctk.CTkLabel(window, text="", text_color="red")
        error_label.pack(pady=5)

        def check_password(event=None):
            if mk.get() == "4321":
                window.destroy()
                AdminMode(refresh_menu_callback=self.load_menu_items)
            else:
                error_label.configure(text="Sai m·∫≠t kh·∫©u!")

        btn = ctk.CTkButton(window, text="X√°c nh·∫≠n", command=check_password)
        btn.pack(pady=20)

        mk.bind("<Return>", check_password)

if __name__ == "__main__":
    root = ctk.CTk()
    app = MenuForGuest(root, "KhachHang01")
    root.mainloop()